# 管理后台技术实现指南

## 技术架构概述

### 前端技术栈
- **框架**: React 18 + TypeScript 5.3
- **路由**: Wouter (轻量级路由方案)
- **状态管理**: TanStack Query (服务端状态)
- **UI组件**: Shadcn/ui + Radix UI
- **样式**: Tailwind CSS
- **图标**: Lucide React
- **构建工具**: Vite

### 后端技术栈
- **运行时**: Node.js 20
- **框架**: Express.js 4.18
- **ORM**: Drizzle ORM
- **数据库**: PostgreSQL 15 (Neon Serverless)
- **认证**: Passport.js (Session-based)
- **验证**: Zod

## 前后端交互模式

### 1. API请求封装

前端统一的API请求函数：

```typescript
const apiRequest = async (method: string, url: string, data?: any) => {
  const response = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: data ? JSON.stringify(data) : undefined,
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw { status: response.status, ...error };
  }
  
  return response.json();
};
```

### 2. 使用TanStack Query管理服务端状态

查询示例：
```typescript
const { data: platformStats, isLoading: statsLoading } = useQuery<PlatformStats>({
  queryKey: ["/api/admin/stats", timeRange],
  queryFn: () => apiRequest("GET", `/api/admin/stats?timeRange=${timeRange}`),
  enabled: !!user && user.role === "admin",
});
```

变更示例：
```typescript
const moderateApplicationMutation = useMutation({
  mutationFn: ({ id, action, notes }: { id: number; action: string; notes?: string }) =>
    apiRequest("POST", `/api/admin/moderate/application/${id}`, { action, notes }),
  onSuccess: () => {
    toast({ title: "操作成功", description: "申请状态已更新" });
    queryClient.invalidateQueries({ queryKey: ["/api/admin/content/moderation"] });
  },
  onError: (error: any) => {
    toast({ 
      title: "操作失败", 
      description: error.error || "操作失败，请重试",
      variant: "destructive" 
    });
  },
});
```

### 3. 认证和权限检查

前端路由保护：
```typescript
<RoleRoute 
  path="/platform/admin" 
  component={AdvancedAdminPage}
  roles={[USER_ROLES.ADMIN, USER_ROLES.SUPERADMIN]}
/>
```

后端权限中间件：
```typescript
// 所有管理API的权限检查
if (!req.isAuthenticated() || req.user!.role !== "admin") {
  return res.status(403).json({ error: "Admin access required" });
}
```

## 关键功能实现

### 1. 实时数据更新

使用TanStack Query的自动重新获取：
```typescript
// 定时刷新统计数据
const { data: platformStats } = useQuery({
  queryKey: ["/api/admin/stats"],
  queryFn: fetchStats,
  refetchInterval: 30000, // 30秒刷新一次
});
```

### 2. 批量操作优化

并行请求处理：
```typescript
// 获取多个统计数据
const [totalUsers, activeUsers, pendingUsers] = await Promise.all([
  db.select({ count: count() }).from(users),
  db.select({ count: count() }).from(users).where(gte(users.createdAt, cutoffDate)),
  db.select({ count: count() }).from(cofounderApplications).where(eq(cofounderApplications.status, 'pending')),
]);
```

### 3. 分页和搜索实现

前端分页组件：
```typescript
const [page, setPage] = useState(1);
const [searchTerm, setSearchTerm] = useState("");

const { data: usersData } = useQuery({
  queryKey: ["/api/admin/users", page, searchTerm],
  queryFn: () => apiRequest("GET", 
    `/api/admin/users?page=${page}&search=${searchTerm}`
  ),
});
```

后端分页查询：
```typescript
async getUsers(page: number = 1, limit: number = 50) {
  const offset = (page - 1) * limit;
  
  const results = await db
    .select()
    .from(users)
    .limit(limit)
    .offset(offset)
    .orderBy(desc(users.createdAt));
    
  return {
    users: results,
    total: totalCount,
    pages: Math.ceil(totalCount / limit),
  };
}
```

### 4. 文件导出实现

后端导出接口：
```typescript
app.get("/api/admin/export/:type", async (req, res) => {
  const type = req.params.type;
  const data = await adminService.exportPlatformData(type);
  
  res.setHeader('Content-Type', 'application/json');
  res.setHeader('Content-Disposition', 
    `attachment; filename=${type}-export-${new Date().toISOString().split('T')[0]}.json`
  );
  return res.json(data);
});
```

前端下载触发：
```typescript
<Button 
  onClick={() => window.open('/api/admin/export/users')}
>
  导出用户数据
</Button>
```

## 性能优化策略

### 1. 查询优化

使用数据库索引：
```typescript
// 在schema中定义索引
export const usersIndex = index("users_email_idx").on(users.email);
export const applicationsIndex = index("applications_status_idx").on(cofounderApplications.status);
```

### 2. 缓存策略

TanStack Query缓存配置：
```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5分钟
      cacheTime: 10 * 60 * 1000, // 10分钟
    },
  },
});
```

### 3. 懒加载实现

Tab内容懒加载：
```typescript
<TabsContent value="users" className="space-y-6">
  {activeTab === 'users' && <UserManagementContent />}
</TabsContent>
```

### 4. 虚拟滚动

大列表优化：
```typescript
import { ScrollArea } from "@/components/ui/scroll-area";

<ScrollArea className="h-96">
  {items.map(item => <ItemRow key={item.id} item={item} />)}
</ScrollArea>
```

## 错误处理机制

### 1. 全局错误边界

```typescript
<ErrorBoundary>
  <AdminPage />
</ErrorBoundary>
```

### 2. API错误处理

统一错误格式：
```typescript
interface ApiError {
  error: string;
  code?: string;
  details?: any;
}
```

错误展示：
```typescript
const { toast } = useToast();

// 在mutation的onError中
onError: (error: ApiError) => {
  toast({
    title: "操作失败",
    description: error.error || "未知错误",
    variant: "destructive",
  });
}
```

### 3. 网络错误重试

```typescript
const { data, error, refetch } = useQuery({
  queryKey: ["admin-data"],
  queryFn: fetchData,
  retry: 3,
  retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
});
```

## 安全最佳实践

### 1. XSS防护

- 使用React自动转义
- 避免使用dangerouslySetInnerHTML
- 对用户输入进行验证

### 2. CSRF防护

使用session-based认证自带CSRF保护：
```typescript
app.use(session({
  secret: process.env.SESSION_SECRET!,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true,
    sameSite: 'strict'
  }
}));
```

### 3. 输入验证

使用Zod进行严格验证：
```typescript
const moderateUserSchema = z.object({
  action: z.enum(['suspend', 'unsuspend', 'warn']),
  reason: z.string().min(1).max(500),
});

// 在API中使用
const { action, reason } = moderateUserSchema.parse(req.body);
```

### 4. 敏感数据处理

API密钥脱敏：
```typescript
config: {
  apiKey: config?.apiKey ? '***' + config.apiKey.slice(-4) : '',
  baseUrl: config?.baseUrl || '',
}
```

## 开发工具配置

### 1. TypeScript配置

```json
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true
  }
}
```

### 2. ESLint配置

```json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react-hooks/recommended"
  ]
}
```

### 3. 开发环境变量

```env
# .env.development
DATABASE_URL=postgresql://user:pass@localhost:5432/rfn_dev
SESSION_SECRET=dev-secret-key
OPENAI_API_KEY=sk-...
```

## 部署注意事项

### 1. 环境变量管理

必需的生产环境变量：
- DATABASE_URL
- SESSION_SECRET
- OPENAI_API_KEY
- 其他AI提供商密钥

### 2. 构建优化

```bash
# 生产构建
npm run build

# 输出目录
# 前端: dist/public
# 后端: dist/index.js
```

### 3. 性能监控

集成性能监控服务：
- 前端性能: Web Vitals
- 后端性能: APM工具
- 错误追踪: Sentry

### 4. 备份策略

- 数据库定期备份
- 用户上传文件备份
- 配置文件版本控制

## 故障排查指南

### 1. 常见问题

**权限错误 (403)**
- 检查用户角色
- 验证session状态
- 查看认证中间件

**数据不更新**
- 检查缓存设置
- 验证invalidateQueries调用
- 查看网络请求

**性能问题**
- 分析慢查询
- 检查N+1查询
- 优化批量操作

### 2. 调试技巧

开启详细日志：
```typescript
if (process.env.NODE_ENV === 'development') {
  console.log('SQL:', query.toSQL());
}
```

使用React DevTools和TanStack Query DevTools进行前端调试。

### 3. 监控和告警

设置关键指标监控：
- API响应时间 > 1s
- 错误率 > 1%
- 数据库连接池耗尽
- 内存使用异常

## 最佳实践总结

1. **保持代码一致性**: 遵循项目代码规范
2. **优化用户体验**: 加载状态、错误提示、操作反馈
3. **安全第一**: 输入验证、权限检查、数据脱敏
4. **性能意识**: 懒加载、缓存、批量操作
5. **可维护性**: 清晰的代码结构、充分的错误处理、完善的日志